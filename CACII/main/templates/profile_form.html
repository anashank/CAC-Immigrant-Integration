{% extends 'base_new.html' %}

{% block content %}
    <div class="container">
        <div class="sidebar"></div>

        <div class="content">
            <br></br>
            <h2>{% if form.instance.pk %}Edit Profile{% else %}New Account Set Up{% endif %}</h2>
            <form id="profile-form" method="post" class="account-setup-form">
                {% csrf_token %}
                <!-- Your existing form fields here -->

                <input type="submit" value="Submit" class="submit-button">
            </form>

            <!-- Spinner -->
            <div id="spinner" class="d-none text-center mt-3">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>

            <!-- Messages -->
            <div class="messages mt-3">
                {% for message in messages %}
                    <div class="alert alert-success" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
    document.getElementById('profile-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        // Show the spinner
        document.getElementById('spinner').classList.remove('d-none');

        // Get form data
        const form = document.getElementById('profile-form');
        const formData = new FormData(form);

        // Delay form submission
        setTimeout(() => {
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value
                }
            }).then(response => response.json()) // Expect JSON response
            .then(data => {
                if (data.success) {
                    // Update the messages section
                    const messagesDiv = document.querySelector('.messages');
                    messagesDiv.innerHTML = `<div class="alert alert-success" role="alert">${data.message}</div>`;
                    
                    // Hide the spinner
                    document.getElementById('spinner').classList.add('d-none');
                    
                    // Redirect to the timeline page
                    window.location.href = '/timeline/'; // Update this with your actual timeline URL
                } else {
                    // Update the messages section with an error message
                    const messagesDiv = document.querySelector('.messages');
                    messagesDiv.innerHTML = `<div class="alert alert-danger" role="alert">${data.message}</div>`;
                    
                    // Hide the spinner
                    document.getElementById('spinner').classList.add('d-none');
                }
            }).catch(error => {
                console.error('Error:', error);
                document.getElementById('spinner').classList.add('d-none');
            });
        }, 5000); // 5 seconds delay
    });
    </script>
{% endblock %}
